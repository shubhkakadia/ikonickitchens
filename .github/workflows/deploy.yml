name: Ikonic Kitchens Deployment

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Deploy to Server
        run: |
          BRANCH="${{ github.ref_name }}"

          if [[ "$BRANCH" == "dev" ]]; then
            echo "Deploying to DEVELOPMENT SERVER"
            REMOTE_PATH="/home/ikonic-server/ikonickitchens-dev"
            ENV_DATA="${{ secrets.DEV_ENV }}"
            PM2_NAME="ikonickitchens-dev"
            PORT=4000
            BACKUP=false
          else
            echo "Deploying to PRODUCTION SERVER"
            REMOTE_PATH="/home/ikonic-server/ikonickitchens"
            ENV_DATA="${{ secrets.PROD_ENV }}"
            PM2_NAME="ikonickitchens"
            PORT=3000
            BACKUP=true
          fi

          echo "Remote path: $REMOTE_PATH"

          # Since runner is on the same server, just copy files
          rsync -avz --delete --exclude=".git" --exclude="node_modules" --exclude=".next" --exclude="/mediauploads" --exclude="generated" \
            ./ $REMOTE_PATH/

          # Setup app
          cd $REMOTE_PATH

          # Write .env file
          echo "$ENV_DATA" > .env

          # Install dependencies
          npm install

          # ===== PRODUCTION DATABASE BACKUP =====
          if [[ "$BACKUP" == "true" ]]; then
            echo "=== Running quick SQL backup (pre-deploy) ==="

            BACKUP_FILE=/home/ikonic-server/db_backups/db_backup_$(date +%Y-%m-%d_%H-%M-%S).sql
            mysqldump -h ${{ secrets.MYSQL_HOST }} -u ${{ secrets.MYSQL_USER }} -p'${{ secrets.MYSQL_PASSWORD }}' ${{ secrets.MYSQL_DB }} > $BACKUP_FILE

            echo "Quick database backup created successfully: $BACKUP_FILE"


            echo "=== Running FULL backup script (DB + media) ==="

            FULL_BACKUP_SCRIPT="/home/ikonic-server/auto_backups/scripts/prod_full_backup.sh"

            if [[ -x "$FULL_BACKUP_SCRIPT" ]]; then
              bash "$FULL_BACKUP_SCRIPT"
              echo "Full backup completed successfully."
            else
              echo "ERROR: Full backup script missing or not executable: $FULL_BACKUP_SCRIPT"
            fi

            echo "=== All production backups completed ==="
          fi

          # Run prisma migrations
          npx prisma migrate deploy

          # Generate Prisma client
          npx prisma generate

          # Build Next.js app
          npm run build

          # Start PM2 process
          pm2 restart $PM2_NAME || pm2 start npm --name $PM2_NAME -- start -- --port $PORT

          pm2 save
